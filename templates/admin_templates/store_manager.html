{% extends 'base.html' %}
{% load static %}

{% block title %}Deal Scanner - Winkels{% endblock %}

{% block head %}
    <link rel="stylesheet" href="{% static 'css/theme_v2_store_manager.css' %}">
    <link rel="stylesheet" href="{% static 'js/store_manager.js' %}">
    {# Font Awesome CDN (make sure to use a recent version if you have one) #}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<style>
    body.no-scroll {
        overflow: hidden;
    }

    /* --- Custom Styled Radio Buttons --- */

.radio-group {
    display: flex;
    gap: 1rem;
    margin-top: 0.5rem;
    flex-wrap: wrap;
}

.radio-group label {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    font-weight: 400;
    font-size: 0.95rem;
    color: var(--primary-text-color);
    cursor: pointer;
}

/* Hide default radio */
.radio-group input[type="radio"] {
    appearance: none;
    width: 16px;
    height: 16px;
    border: 2px solid var(--color-gray-medium);
    border-radius: 50%;
    position: relative;
    cursor: pointer;
    transition: 0.2s;
}

/* Selected state */
.radio-group input[type="radio"]:checked {
    border-color: var(--color-accent);
    background-color: var(--color-accent);
}

/* Inner dot */
.radio-group input[type="radio"]:checked::before {
    content: '';
    display: block;
    width: 6px;
    height: 6px;
    margin: 3px;
    background: white;
    border-radius: 50%;
}

#newStoreForm {
    position: relative;
    z-index: 1;
}

#searchResults {
    display: none;
    border: 1px solid #ddd;
    background: white;
    position: absolute;
    max-height: 250px;
    overflow-y: auto;
    z-index: 1000;
    margin-top: 5px;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    width: 100%;
    padding: 5px;
}

.search-result-item {
    padding: 8px 12px;
    display: flex;
    align-items: center;
    cursor: pointer;
}

.search-result-item:hover {
    background: #f5f5f5;
}

.search-result-logo {
    width: 32px;
    height: 32px;
    object-fit: contain;
    margin-right: 10px;
}

.badge {
    margin-left: auto;
    background: #4caf50;
    color: white;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 12px;
}

    @keyframes fadeInCard {
    0% {
        opacity: 0;
    }
    100% {
        opacity: 1;
    }
}

.store-card.fade-in-card {
    animation-name: fadeInCard;
    animation-duration: 0.5s; /* Adjust the duration as needed */
    animation-fill-mode: forwards; /* Keep the end state of the animation */
    opacity: 0; /* Start with opacity 0 */
}



/* A container for the search bar to manage spacing and alignment */
.search-bar {
display: flex;
justify-content: center;
width: 100%;
max-width: 600px;
margin: 1.5rem auto;
}

/* Styling for the search input field itself */
#searchStoreInput {
width: 100%;
padding: 0.75rem 1rem;
border: 1px solid #e5e7eb;
border-radius: 0.5rem;
font-size: 1rem;
font-family: 'Inter', sans-serif;
color: #1f2937;
background-color: #ffffff;
box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
}

/* Styles for the placeholder text */
#searchStoreInput::placeholder {
color: #9ca3af;
font-weight: 400;
}

/* Focus state for a clean, professional look */
#searchStoreInput:focus {
border: 1px solid #FF4D00;
box-shadow: 0 0 0 3px #fee8e0;
outline: none;
}

</style>

<style>
    :root {
        --gradient-angle: 135deg;
        /* A new, warm palette with yellowish tones */
        --color-1: #ffd1bd; /* Your --color-accent-light */
        --color-2: #fee8e0; /* Your --color-accent-lighter */
        --color-3: #fff3b0; /* Soft Gold */
        --color-4: #fff9de; /* Light Cream */
    }

    header{
        background: linear-gradient(
                var(--gradient-angle),
                var(--color-1),
                var(--color-2),
                var(--color-3),
                var(--color-4)
            );
        background-size: 400% 400%;
        animation: animate-gradient-position 10s ease infinite alternate;
        padding-bottom: 2.5rem !important;
    }

    header button:hover{
        transform: scale(1.05);
    }

    @keyframes animate-gradient-position {
        0% {
            background-position: 0% 50%;
        }
        100% {
            background-position: 100% 50%;
        }
    }
</style>
{% endblock %}

{% block index_header %}
<header>
    <h1>Winkels beheren</h1>
    <button id="updateSheetsBtn" class="action-btn">Sheets updaten</button>
    <div id="updateSheetsLoader" style="display: none;" class="loader-spinner" aria-label="Loading..."></div>
</header>
{% endblock %}

{% block content %}

    <div class="container">

        {% if messages %}
            <div class="flash-messages">
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }}">{{ message }}</div>
                {% endfor %}
            </div>
        {% endif %}

        <div class="form-section signup-card">
            <h3 style="text-align: center; margin-bottom: 1rem;">Nieuwe Winkel Toevoegen</h3>
            <form id="newStoreForm" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="form-group">
                    <label for="id_name">Winkelnaam <span class="required">*</span></label>
                    {{ form.name }}
                    <div id="searchResults">
                        <!-- This should flow above everything but below the input off course -->
                        <!-- When a user enter the winkelnaam, whenever she types something after some delay api call is made and displayed here -->
                    </div>
                </div>

                <div id="email-inputs-container" class="form-group">
                    <label>E-mailadressen (Niet xx@mails.domein.com of xx@notifications.domein.com)<span class="required">*</span></label>
                    <div class="email-input-wrapper">
                        <input type="email" name="email_addresses" class="form-control" placeholder="Voer een e-mailadres in" required>
                        <div id="emailInputsContainer"></div>
                        <button onclick="addEmailInput()" type="button" id="add-email-btn" class="btn-email btn btn-primary btn-sm flex-shrink-0" title="E-mailadres toevoegen">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>

                <div class="form-group">
                    <label for="id_home_url">Website URL <span class="required">*</span></label>
                    {{ form.home_url }}
                </div>

                <div class="form-group">
                    <label for="id_sale_url">Sale Pagina URL <span class="optional">(optioneel)</span></label>
                    {{ form.sale_url }}
                </div>

                <div class="form-group">
                    <label for="id_image_url">Afbeelding <span class="required">*</span></label>
                    {{ form.image_url }}
                </div>

                {# Radio Selects need custom rendering to use the radio-group class #}
                <div class="form-group">
                    <label>Is de mail geverifieerd? <span class="required">*</span></label>
                    <div class="radio-group" id="id_isVerified">
                        {% for choice in form.isVerified %}
                            <label for="{{ choice.id_for_label }}">
                                {{ choice.tag }} {{ choice.choice_label }}
                            </label>
                        {% endfor %}
                    </div>
                </div>

                <!-- NEW -->
                <div class="form-group">
                    <label>Was de domein van de email vreemd? <span class="required">*</span></label>
                    <p style="margin-top: 0; font-size: 0.75rem;">Bijvoorbeeld sent-with@powr.io</p>
                    <div class="radio-group" id="id_isWeirdDomain">
                        {% for choice in form.isWeirdDomain %}
                            <label for="{{ choice.id_for_label }}">
                                {{ choice.tag }} {{ choice.choice_label }}
                            </label>
                        {% endfor %}
                    </div>
                </div>
                <!-- END NEW -->

                <div class="form-group">
                    <label>Moest je man of vrouw aangeven bij de nieuwsbrief? <span class="required">*</span></label>
                    <div class="radio-group" id="id_genderPreferenceSet">
                        {% for choice in form.genderPreferenceSet %}
                            <label for="{{ choice.id_for_label }}">
                                {{ choice.tag }} {{ choice.choice_label }}
                            </label>
                        {% endfor %}
                    </div>
                </div>

                <div class="form-group">
                    <label>Doelgroep winkel <span class="required">*</span></label>
                    <div class="radio-group" id="id_gender">
                        {% for choice in form.gender %}
                            <label for="{{ choice.id_for_label }}">
                                {{ choice.tag }} {{ choice.choice_label }}
                            </label>
                        {% endfor %}
                    </div>
                </div>

                <div class="form-group">
                    <label>Heb je toestemming om de content te gebruiken? <span class="required">*</span></label>
                    <div class="radio-group" id="id_mayUseContent">
                        {% for choice in form.mayUseContent %}
                            <label for="{{ choice.id_for_label }}">
                                {{ choice.tag }} {{ choice.choice_label }}
                            </label>
                        {% endfor %}
                    </div>
                </div>
                
                <!-- Button is only visible when all fields except for Sale Pagina URL  have some value -->
                <button onclick="submitNewStore(this.form)" id="submitNewStoreBtn" type="submit" class="btn-submit">Winkel Toevoegen</button>
            </form>
        </div>

        <h3 style="text-align: center; margin-bottom: 1rem;">Overzicht van Winkels</h3>
        <!-- Filter and Sort Controls -->
        <div class="search-bar">
            <input type="text" name="Zoek winkel" id="searchStoreInput" placeholder="Zoek een winkel" class="form-control">
        </div>

        <div class="filter-section">
            <div class="select-group">
                <label for="sort-select" class="label">Sorteren op:</label>
                <select id="sort-select" class="select-input">
                    <option value="dateIssued" selected>Datum (nieuwste eerst)</option>
                    <option value="dateIssuedReverse">Datum (oude eerst)</option>
                    <option value="name">Naam (a-z)</option>
                    <option value="subscriptions">Abonnementen (meeste eerst)</option>
                    <option value="subscriptionsReverse">Abonnementen (minste eerst)</option>
                </select>
            </div>

            <div class="select-group">
                <label for="filter-select" class="label">Filteren op:</label>
                <select id="filter-select" class="select-input">
                    <option value="none" selected>Alle</option>
                    <option value="verified">Geverifieerd</option>
                    <option value="notVerified">Niet geverifieerd</option>
                    <option value="mayUseContent">Mag content gebruiken</option>
                    <option value="mayNotUseContent">Mag geen content gebruiken</option>
                    <option value="isWeirdDomain">Winkel mail heeft een raar domein</option>
                </select>
            </div>

            <div id="totalResults">
            </div>
        </div>
        
        <div id="stores-grid" class="stores-grid">
            <!-- This will be filled with de sorting -->
        </div>
        <div id="loadingIndicator"  style="display: none; margin-top: 1.5rem;" class="loader-spinner" aria-label="Loading..."></div>
        <button style="margin-top: 1rem;" class="action-btn" id="loadMoreBtn">Meer laden</button>
        <p style="text-align: center; margin-top: 1rem;" id="noStoresMessage">Geen winkels meer.</p>


        {% if not stores %}
            <div class="alert alert-info" style="display: block; margin: 0 auto;">Nog geen winkels toegevoegd.</div>
        {% endif %}
    </div>

{% endblock %}

{% block pop_up_content %}
<div id="editStoreModal" class="modal-overlay">
    <div class="modal-card">
        <button class="close-btn" id="closeModalBtn">&times;</button>
        <div class="form-section signup-card">
            <h3 style="text-align: center; margin-bottom: 1rem;">Winkel Bewerken</h3>
            <form id="editStoreForm" method="post" enctype="multipart/form-data">
                <input type="hidden" name="store_id" id="edit_store_id">

                <div class="form-group">
                    <label for="edit_name">Winkelnaam <span class="required">*</span></label>
                    <input type="text" name="name" id="edit_name" class="form-control" required>
                </div>

                <div id="email-inputs-container" class="form-group">
                    <label>E-mailadressen <span class="required">*</span></label>
                    <div class="email-input-wrapper">
                        <input type="email" name="email_addresses" id="edit_email_addresses" class="form-control" placeholder="Voer een e-mailadres in" required>
                        <div id="editEmailInputsContainer"></div>
                        <button onclick="addEditEmailInput()" type="button" id="add-edit-email-btn" class="btn-email btn btn-primary btn-sm flex-shrink-0" title="E-mailadres toevoegen">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>

                <div class="form-group">
                    <label for="edit_home_url">Website URL <span class="required">*</span></label>
                    <input type="url" name="home_url" id="edit_home_url" class="form-control" required>
                </div>

                <div class="form-group">
                    <label for="edit_sale_url">Sale Pagina URL <span class="optional">(optioneel)</span></label>
                    <input type="url" name="sale_url" id="edit_sale_url" class="form-control">
                </div>

                <div class="form-group">
                    <label for="edit_image_url">Afbeelding (laat leeg om huidige te behouden) <span class="required">*</span></label>
                    <input type="file" name="image_url" id="edit_image_url" class="form-control">
                </div>
                
                <div class="form-group">
                    <label>Is de mail geverifieerd? <span class="required">*</span></label>
                    <div class="radio-group" id="edit_isVerified_group">
                        <label for="edit_isVerified_0">
                            <input type="radio" name="isVerified" value="True" id="edit_isVerified_0"> Ja
                        </label>
                        <label for="edit_isVerified_1">
                            <input type="radio" name="isVerified" value="False" id="edit_isVerified_1"> Nee
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label>Was de domein van de email vreemd? <span class="required">*</span></label>
                    <p style="margin-top: 0; font-size: 0.75rem;">Bijvoorbeeld sent-with@powr.io</p>
                    <div class="radio-group" id="edit_isWeirdDomain_group">
                        <label for="edit_isWeirdDomain_0">
                            <input type="radio" name="isWeirdDomain" value="True" id="edit_isWeirdDomain_0"> Ja
                        </label>
                        <label for="edit_isWeirdDomain_1">
                            <input type="radio" name="isWeirdDomain" value="False" id="edit_isWeirdDomain_1"> Nee
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label>Moest je man of vrouw aangeven bij de nieuwsbrief? <span class="required">*</span></label>
                    <div class="radio-group" id="edit_genderPreferenceSet_group">
                        <label for="edit_genderPreferenceSet_0">
                            <input type="radio" name="genderPreferenceSet" value="True" id="edit_genderPreferenceSet_0"> Ja
                        </label>
                        <label for="edit_genderPreferenceSet_1">
                            <input type="radio" name="genderPreferenceSet" value="False" id="edit_genderPreferenceSet_1"> Nee
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label>Doelgroep winkel: <span class="required">*</span></label>
                    <div class="radio-group" id="edit_gender_group">
                        <label for="edit_gender_0">
                            <input type="radio" name="gender" value="M" id="edit_gender_0"> Male
                        </label>
                        <label for="edit_gender_1">
                            <input type="radio" name="gender" value="F" id="edit_gender_1"> Female
                        </label>
                        <label for="edit_gender_2">
                            <input type="radio" name="gender" value="B" id="edit_gender_2"> Both
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label>Heb je toestemming om de content te gebruiken? <span class="required">*</span></label>
                    <div class="radio-group" id="edit_gender_group">
                        <label for="edit_mayUseContent_0">
                            <input type="radio" name="mayUseContent" value="True" id="edit_mayUseContent_0"> Ja
                        </label>
                        <label for="edit_mayUseContent_1">
                            <input type="radio" name="mayUseContent" value="False" id="edit_mayUseContent_1"> Nee
                        </label>
                    </div>
                </div>
                
                <button onclick="editStore(this.form)" type="submit" class="action-btn save-changes">Wijzigingen Opslaan</button>
                <button type="button" id="deleteStoreBtn" class="btn btn-danger mt-3 ms-2">Verwijder Winkel</button>
            </form>
        </div>
    </div>
</div>

<div id="confirmDeleteModal" class="modal-overlay">
    <div class="confirmation-delete-pop-up">
        <h3>Verwijderen?</h3>
        <button class="close-btn btn-conf" id="deleteConfirmationBtn">Ja</button>
        <button class="close-btn btn-conf" id="closeDeleteConfirmationBtn">Nee</button>
    </div>
</div>
{% endblock %}



{% block scripts %}
<script>
function getCSRFToken() {
    let name = 'csrftoken';
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Function to open the main edit modal
function displayPopUp(id){
    const modal = document.getElementById('editStoreModal');
    modal.classList.add('active');
    document.body.classList.add('no-scroll');

    const store_card = document.querySelector(`.store-card[data-store-id="${id}"]`);
    console.log(store_card.dataset);
    if (!store_card) {
        console.error('Store card not found for ID:', id);
        return;
    }

    document.getElementById('edit_store_id').value = id;
    document.getElementById('edit_name').value = store_card.dataset.storeName;
    document.getElementById('edit_home_url').value = store_card.dataset.storeHomeUrl;
    
    const saleUrl = store_card.dataset.storeSaleUrl;
    document.getElementById('edit_sale_url').value = saleUrl === 'None' ? '' : saleUrl;

    const emailContainer = document.getElementById('editEmailInputsContainer');
    emailContainer.innerHTML = '';
    const emails = store_card.dataset.storeEmails.split(',').filter(email => email.trim() !== '');

    document.getElementById('edit_email_addresses').value = emails.length > 0 ? emails[0] : '';
    
    if (emails.length > 1) {
        emails.slice(1).forEach(email => {
            addEditEmailInput(email.trim());
        });
    }

    const isVerifiedValue = store_card.dataset.isverified;
    const isVerifiedRadio = modal.querySelector(`input[name="isVerified"][value="${isVerifiedValue}"]`);
    if (isVerifiedRadio) {
        isVerifiedRadio.checked = true;
    }

    const isweirddomainValue = store_card.dataset.isweirddomain;
    const isweirddomainRadio = modal.querySelector(`input[name="isWeirdDomain"][value="${isweirddomainValue}"]`);
    if (isweirddomainRadio) {
        isweirddomainRadio.checked = true;
    } else{
        console.log("geen weird gevonden.")
    }



    const genderPreferenceSetValue = store_card.dataset.genderpreferenceset;
    const genderPreferenceSetRadio = modal.querySelector(`input[name="genderPreferenceSet"][value="${genderPreferenceSetValue}"]`);
    if (genderPreferenceSetRadio) {
        genderPreferenceSetRadio.checked = true;
    }

    const genderValue = store_card.dataset.gender;

    if (genderValue) {
        const genderRadio = modal.querySelector(`input[name="gender"][value="${genderValue}"]`);
        if (genderRadio) {
            genderRadio.checked = true;
        }
    }

    const mayUseContentValue = store_card.dataset.mayusecontent;

    if (mayUseContentValue) {
        const mayUseContentRadio = modal.querySelector(`input[name="mayUseContent"][value="${mayUseContentValue}"]`);
        if (mayUseContentRadio) {
            mayUseContentRadio.checked = true;
        }
    }
}

// Function to close the modal and reset the form
function closeModal() {
    const modal = document.getElementById('editStoreModal');
    modal.classList.remove('active');
    document.body.classList.remove('no-scroll');
    document.getElementById('editStoreForm').reset();
}

// Function to add a new email input field in the edit modal
function addEditEmailInput(value = '') {
    const container = document.getElementById('editEmailInputsContainer');
    const inputName = 'email_addresses';
    const wrapper = document.createElement('div');
    wrapper.classList.add('email-input-wrapper', 'email-input-wrapper-content');
    
    const input = document.createElement('input');
    input.type = 'email';
    input.name = inputName;
    input.classList.add('form-control');
    input.placeholder = 'Voer een e-mailadres in';
    input.required = true;
    input.value = value;

    const delBtn = document.createElement('button');
    delBtn.type = 'button';
    delBtn.classList.add('btn', 'btn-email', 'btn-danger');
    delBtn.title = 'E-mailadres verwijderen';
    delBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';

    delBtn.addEventListener('click', () => {
        wrapper.remove();
    });

    wrapper.appendChild(input);
    wrapper.appendChild(delBtn);
    container.appendChild(wrapper);
}

function showDeleteConfirmation(storeId) {
    const confirmModal = document.getElementById('confirmDeleteModal');
    confirmModal.classList.add('active');
    confirmModal.dataset.storeId = storeId; // Store the ID on the modal element
}

// Function to close the delete confirmation modal
function closeDeleteConfirmation() {
    const confirmModal = document.getElementById('confirmDeleteModal');
    confirmModal.classList.remove('active');
    confirmModal.dataset.storeId = ''; // Clear the stored ID
}

// Function to handle the delete API call
function deleteStore(storeId) {
    const csrftoken = getCSRFToken();

    fetch(`/deals/stores-manager/delete/${storeId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken,
            'Content-Type': 'application/json',
        },
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // Remove the store card from the DOM
            const storeCard = document.querySelector(`.store-card[data-store-id="${storeId}"]`);
            if (storeCard) {
                storeCard.remove();
            }
            // Close the modals and show a success message
            closeModal();
            closeDeleteConfirmation();
            window.displayMessage('success', data.message);
        } else {
            window.displayMessage('error', data.error);
        }
    })
    .catch(error => {
        window.displayMessage('error', error);
    });
}

// Function to handle the edit API call
function editStore(formElement){
    const storeId = formElement.querySelector('#edit_store_id').value;
    event.preventDefault();
     // Collect all email inputs and join them into a single string
    const mainEmailInput = document.getElementById('edit_email_addresses');
    const dynamicEmailInputs = document.getElementById('editEmailInputsContainer').querySelectorAll('input[name="email_addresses"]');
    
    let allEmails = [];
    if (mainEmailInput && mainEmailInput.value.trim() !== '') {
        allEmails.push(mainEmailInput.value.trim());
    }
    dynamicEmailInputs.forEach(input => {
        if (input.value.trim() !== '') {
            allEmails.push(input.value.trim());
        }
    });

    const formData = new FormData(formElement);
    formData.append('store_id', storeId);

    formData.delete('email_addresses');

    // Add the combined email string back to the form data
    formData.append('email_addresses', allEmails.join(','));

    fetch(`/deals/stores-manager/edit/${storeId}/`, {
        method: "POST",
        headers: {
            "X-CSRFToken": getCSRFToken(),
        },
        body: formData
            
    }).then(response => response.json())
    .then(data => {
        if (data.error){
            window.displayMessage('error', data.error);
            return;
        } else{
            window.displayMessage('success', data.message);
            submitButton.classList.remove('ready-submit');
            submitButton.onclick = null;
            newStoreForm.reset();
            closeModal();
        }
    })
    .catch(error => {
        window.displayMessage('error', error);
    });
}

// Event Listeners for all modal functionality
document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('updateSheetsBtn').addEventListener('click', async () => {
        const button = document.getElementById('updateSheetsBtn');
        const loader = document.getElementById('updateSheetsLoader');
        
        // Verberg de knop en toon de loader om aan te geven dat de bewerking bezig is.
        button.style.display = 'none';
        loader.style.display = 'block';

        try {
            // Maak een POST-verzoek naar het Django-endpoint
            const response = await fetch('/api/set-stores-in-sheets/', {
                method: 'POST',
                headers: {
                    "X-CSRFToken": getCSRFToken(),
                }
            });

            if (response.ok) {
                const data = await response.json();
                window.displayMessage('success', data.message);
            } else {
                const errorData = await response.json();
                window.displayMessage('error', `Fout: ${errorData.error}`);
            }
        } catch (error) {
            // Vang netwerk- of andere fouten op
            window.displayMessage('error', 'Er is een onverwachte fout opgetreden.');
            console.error('Fetch error:', error);
        } finally {
            // Toon de knop opnieuw en verberg de loader, ongeacht het resultaat
            button.style.display = 'block';
            loader.style.display = 'none';
        }
    });


    // Open main edit modal on 'Bewerken' button click
    document.querySelectorAll('.store-card .primary-btn').forEach(button => {
        button.addEventListener('click', (event) => {
            const card = event.target.closest('.store-card');
            const storeId = card.dataset.storeId;
            displayPopUp(storeId);
        });
    });

    // Close main edit modal via the 'x' button
    document.getElementById('closeModalBtn').addEventListener('click', closeModal);

    // Close main edit modal when clicking the overlay (background)
    document.getElementById('editStoreModal').addEventListener('click', (event) => {
        if (event.target === event.currentTarget) {
            closeModal();
        }
    });

    // Close main edit modal when pressing the 'Escape' key
    document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && document.getElementById('editStoreModal').classList.contains('active')) {
            closeModal();
        }
    });

    // --- New event listeners for the delete confirmation modal ---
    
    // Open the confirmation modal when the 'Verwijder Winkel' button is clicked
    document.getElementById('deleteStoreBtn').addEventListener('click', () => {
        const storeId = document.getElementById('edit_store_id').value;
        showDeleteConfirmation(storeId);
    });

    // Handle 'Ja' (Yes) button click in the confirmation modal
    document.getElementById('deleteConfirmationBtn').addEventListener('click', () => {
        const storeId = document.getElementById('confirmDeleteModal').dataset.storeId;
        if (storeId) {
            deleteStore(storeId);
        }
    });

    // Handle 'Nee' (No) button click in the confirmation modal
    document.getElementById('closeDeleteConfirmationBtn').addEventListener('click', closeDeleteConfirmation);
    
    // Close confirmation modal when clicking the overlay
    document.getElementById('confirmDeleteModal').addEventListener('click', (event) => {
        if (event.target === event.currentTarget) {
            closeDeleteConfirmation();
        }
    });
});

// Event listener to open the modal when "Bewerken" is clicked
document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.store-card .primary-btn').forEach(button => {
        button.addEventListener('click', (event) => {
            const card = event.target.closest('.store-card');
            const storeId = card.dataset.storeId;
            displayPopUp(storeId);
        });
    });
});

function addEmailInput(value = '') {
    const container = document.getElementById('emailInputsContainer');
    const inputName = 'email_addresses';
    const wrapper = document.createElement('div');
    wrapper.classList.add('email-input-wrapper', 'email-input-wrapper-content');

    const input = document.createElement('input');
    input.type = 'email';
    input.name = inputName;
    input.classList.add('form-control');
    input.placeholder = 'Voer een e-mailadres in';
    input.required = true;
    input.value = value;

    const delBtn = document.createElement('button');
    delBtn.type = 'button';
    delBtn.classList.add('btn', 'btn-email', 'btn-danger');
    delBtn.title = 'E-mailadres verwijderen';
    delBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';

    delBtn.addEventListener('click', () => {
        wrapper.remove(); // Use .remove() for modern browsers
    });

    wrapper.appendChild(input);
    wrapper.appendChild(delBtn);

    // Append the new input wrapper to the specified container
    container.appendChild(wrapper);
}

const newStoreForm = document.querySelector('.form-section form');
const newStoreEmailContainer = document.getElementById('emailInputsContainer');

const StoreForm = document.getElementById('newStoreForm');
const submitButton = document.getElementById('submitNewStoreBtn');
const emailInputsContainer = document.getElementById('emailInputsContainer');

// Function to check if all required fields have a value
function checkFormValidity() {
    // Get all required inputs, excluding the sale_url
    const requiredInputs = StoreForm.querySelectorAll('input:not([name="sale_url"])[required], textarea[required]');

    let allFieldsValid = true;

    // Check all required text/file inputs
    for (const input of requiredInputs) {
        if (input.type === 'file') {
            // For file input, check if a file has been selected
            if (!input.files || input.files.length === 0) {
                allFieldsValid = false;
                break;
            }
        } else if (input.type === 'radio') {
            // For radio buttons, check if any option in the group is checked
            const radioGroupName = input.name;
            if (!StoreForm.querySelector(`input[name="${radioGroupName}"]:checked`)) {
                allFieldsValid = false;
                break;
            }
        } else {
            // For text/URL/email inputs, check if the value is not just whitespace
            if (input.value.trim() === '') {
                allFieldsValid = false;
                break;
            }
        }
    }

    // Check the dynamic email fields specifically
    const dynamicEmails = emailInputsContainer.querySelectorAll('input');
    const mainEmailInput = StoreForm.querySelector('input[name="email_addresses"]');
    if (mainEmailInput.value.trim() === '' && dynamicEmails.length === 0) {
        allFieldsValid = false;
    }

    if (allFieldsValid) {
        submitButton.classList.add('ready-submit');
        submitButton.onclick = function() { submitNewStore(this.form); };
    } else {
        submitButton.classList.remove('ready-submit');
        submitButton.onclick = null;
    }
}

// Add event listeners to all required inputs
newStoreForm.addEventListener('input', checkFormValidity);
document.addEventListener('DOMContentLoaded', checkFormValidity);


function submitNewStore(formElement){
    event.preventDefault();

    // Collect all email inputs and join them into a single string
    const mainEmailInput = document.querySelector('#email-inputs-container input[name="email_addresses"]');
    const dynamicEmailInputs = newStoreEmailContainer.querySelectorAll('input[name="email_addresses"]');
    
    let allEmails = [];
    if (mainEmailInput && mainEmailInput.value.trim() !== '') {
        allEmails.push(mainEmailInput.value.trim());
    }
    dynamicEmailInputs.forEach(input => {
        if (input.value.trim() !== '') {
            allEmails.push(input.value.trim());
        }
    });

    // Create a new FormData object
    const formData = new FormData(formElement);
    
    // Remove the old email fields
    formData.delete('email_addresses');

    // Add the combined email string back to the form data
    formData.append('email_addresses', allEmails.join(','));

    fetch("{% url 'stores_manager' %}", {
        method: "POST",
        headers: {
            "X-CSRFToken": getCSRFToken(),
        },
        body: formData
            
    }).then(response => response.json())
    .then(data => {
        if (data.error){
            window.displayMessage('error', data.error);
        } else{
            window.displayMessage('success', data.message);
            submitButton.classList.remove('ready-submit');
            submitButton.onclick = null;
            newStoreForm.reset();
        }
    })
    .catch(error => {
        window.displayMessage('error', error);
    });
};




// ALL NEW JAVASCRIPT FOR DYNAMIC NEW STORES //

// The URL for your Django API endpoint
const API_URL = '/api/get-stores-admin/';
// Get the CSRF token from the cookie
const CSRF_TOKEN = getCSRFToken();

// DOM elements
const storesGrid = document.getElementById('stores-grid');
const loadingIndicator = document.getElementById('loadingIndicator');
const sortSelect = document.getElementById('sort-select');
const filterSelect = document.getElementById('filter-select');
const noStoresMessage = document.getElementById('noStoresMessage');

// NEW
const loadMoreBtn = document.getElementById('loadMoreBtn');


// State variables
let currentPage = 1;
let currentSort = sortSelect.value;
let currentFilter = filterSelect.value;
let isLoading = false;
let hasNextPage = true;

/**
 * Renders a single store card HTML element from store data.
 * @param {object} store - The store data object from the API.
 * @returns {string} The HTML string for the store card.
 */
const createStoreCard = (store) => {
    const imageUrl = store.image_url || 'https://placehold.co/400x200/cccccc/333333?text=Geen+Banner';
    const domainLink = store.home_url && store.domain
        ? `<p class="domain-link"><a href="${store.home_url}" target="_blank" class="link">${store.domain}</a></p>`
        : '';

    // Convert JS booleans → Django-style strings
    const isVerifiedValue = store.verified === true ? "True" : "False";
    const genderPreferenceSetValue = store.genderPreferenceSet === true ? "True" : "False";
    const mayUseContentValue = store.mayUseContent === true ? "True" : "False";
    const isWeirdDomainValue = store.is_weird_domain === true ? "True" : "False";


    return `
        <div id="store_${store.id}" class="store-card card"
            data-store-id="${store.id}"
            data-store-name="${store.name}"
            data-store-home-url="${store.home_url}"
            data-store-sale-url="${store.sale_url}"
            data-store-image-url="${store.image_url}"
            data-store-emails="${store.email_addresses_comma}"
            data-isverified="${isVerifiedValue}"
            data-genderpreferenceset="${genderPreferenceSetValue}"
            data-gender="${store.gender}"
            data-mayusecontent="${mayUseContentValue}"
            data-isweirddomain="${isWeirdDomainValue}"
        >
            <div class="card-header">
                ${store.name || 'Onbekende Winkel'}
            </div>
            <div class="card-body">
                <img src="${imageUrl}" alt="Banner for ${store.name}" class="store-banner">
                ${domainLink}
                <p style="text-align: center;">${store.subscriptions} abonnees</p>
                <button class="primary-btn" title="Winkel bewerken" style="margin: 0 auto; display: block;">
                    Bewerken
                </button>
            </div>
        </div>
    `;
};


/**
 * Fetches stores from the API and renders them.
 * @param {boolean} reset - If true, clears the grid and resets page number.
 */
const fetchStores = async (reset = false) => {

    // NEW //
    const storeInputName = document.getElementById('searchStoreInput')

    
    if (isLoading || (!hasNextPage && !reset)) {
        return;
    }
    
    isLoading = true;
    loadingIndicator.style.display = 'block';
    noStoresMessage.style.display = 'none';
    loadMoreBtn.style.display = 'none';


    if (reset) {
        currentPage = 1;
        storesGrid.innerHTML = '';
        document.getElementById('totalResults').innerHTML = '';
        hasNextPage = true;
    }

    try {
        const payload = {
            page: currentPage,
            order: currentSort,
        };
        // Only add the sort_on parameter if a specific filter is selected
        if (currentFilter !== 'none') {
            payload.sort_on = currentFilter;
        }

        // Add the search term to the payload if it exists
        if (storeInputName.value && storeInputName.value.trim() !== '') {
            console.log(storeInputName.value)
            payload.search_name = storeInputName.value;
        } else{
            console.log("no search term")
            payload.search_name = null;
        }

        const response = await fetch(API_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': CSRF_TOKEN,
            },
            body: JSON.stringify(payload),
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
        }

        const data = await response.json();
        
        if (data.stores.length === 0 && currentPage === 1) {
            noStoresMessage.style.display = 'block';
        } else {
            document.getElementById('totalResults').innerHTML = `<p>${data.totalFound} resultaten</p>`;
            data.stores.forEach((store, index) => {
                // const storeCardHtml = createStoreCard(store);
                // storesGrid.insertAdjacentHTML('beforeend', storeCardHtml);
                const storeCardHtml = createStoreCard(store);
                
                // Create a temporary element to safely parse the HTML string
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = storeCardHtml;
                const storeCard = tempDiv.firstElementChild;
                
                // Add the fade-in class
                storeCard.classList.add('fade-in-card');
                
                // Set the animation delay based on the card's index
                storeCard.style.animationDelay = `${index * 0.05}s`;
                
                // Append the fully configured card to the grid
                storesGrid.appendChild(storeCard);
            });
            // get amount of elements in grid
            const gridItems = document.querySelectorAll('.store-card');
            if (gridItems.length === data.totalFound) {
                noStoresMessage.style.display = 'block';
            } else{
                loadMoreBtn.style.display = 'block';
            };
        }
        
        hasNextPage = data.hasNextPage;

    } catch (error) {
        console.error('Failed to fetch stores:', error);
        // You could add a user-facing error message here
        alert('Er is een fout opgetreden bij het laden van de winkels.');
    } finally {
        isLoading = false;
        loadingIndicator.style.display = 'none';
        
        // This part handles a common issue where the first page doesn't fill the screen
        // and the scroll event isn't triggered. We immediately check for more items.
        if (hasNextPage && document.body.offsetHeight < window.innerHeight) {
            currentPage++;
            fetchStores();
        }
        
        document.querySelectorAll('.store-card .primary-btn').forEach(button => {
            button.addEventListener('click', (event) => {
                const card = event.target.closest('.store-card');
                const storeId = card.dataset.storeId;
                displayPopUp(storeId);
            });
        });
    }
};

// Event Listeners
window.addEventListener('scroll', () => {
    // Check if the user has scrolled to the bottom of the page.
    if (window.innerHeight + window.scrollY >= document.body.offsetHeight) {
        // If there's a next page and we aren't already loading, fetch more stores.
        if (hasNextPage && !isLoading) {
            currentPage++;
            fetchStores();
        }
    }
});

sortSelect.addEventListener('change', (e) => {
    currentSort = e.target.value;
    fetchStores(true); // Reset and fetch new data
});

filterSelect.addEventListener('change', (e) => {
    currentFilter = e.target.value;
    fetchStores(true); // Reset and fetch new data
});

// Initial fetch on page load
fetchStores();

document.addEventListener('DOMContentLoaded', () => {
    // Get the search input element by its ID.
    const searchInput = document.getElementById('searchStoreInput');

    // Check if the input element exists to prevent errors.
    if (searchInput) {
        // Add an 'input' event listener. This event fires whenever the value
        // of an <input> element has been changed.
        searchInput.addEventListener('input', () => {
            // Call the fetchStores function and pass 'true' to it.
            // The 'true' argument tells fetchStores to reset the grid
            // and start a new search from page 1 with the new search term.
            fetchStores(true);
        });
    }
});



document.addEventListener("DOMContentLoaded", () => {
    const nameInput = document.getElementById("id_name");
    const resultsContainer = document.getElementById("searchResults");

    let searchTimeout = null;

    nameInput.addEventListener("input", () => {
        resultsContainer.style.display = "block";
        const query = nameInput.value.trim();

        if (searchTimeout) clearTimeout(searchTimeout);

        if (query.length === 0) {
            resultsContainer.innerHTML = "";
            resultsContainer.style.display = "none";
            return;
        }

        searchTimeout = setTimeout(async () => {
            try {
                const response = await fetch("/api/search-stores/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": getCSRFToken(),
                    },
                    body: JSON.stringify({ query, page: 1 })
                });

                const data = await response.json();

                if (data.stores && data.stores.length > 0) {
                    resultsContainer.innerHTML = data.stores.map(store => `
                        <div class="search-result-item" data-store-id="${store.id}">
                            <img src="${store.image_url}" alt="${store.name}" class="search-result-logo">
                            <span>${store.name}</span>
                            ${store.is_subscribed ? '<span class="badge">✓ Subscribed</span>' : ''}
                        </div>
                    `).join("");
                } else {
                    resultsContainer.innerHTML = "<div class='search-result-empty'><p style='text-align: center;'>Geen winkels gevonden.</p></div>";
                }
            } catch (error) {
                console.error("Search error:", error);
                resultsContainer.innerHTML = "<div class='search-result-error'>Er ging iets mis.</div>";
            }
        }, 300);
    });

    // Show dropdown only when input is focused
    nameInput.addEventListener("focus", () => {
        if (resultsContainer.innerHTML.trim() !== "") {
            resultsContainer.style.display = "block";
        }
    });

    // Hide dropdown on blur, but allow clicking items
    nameInput.addEventListener("blur", () => {
        setTimeout(() => {
            resultsContainer.style.display = "none";
        }, 200); // delay to allow click
    });

    loadMoreBtn.addEventListener('click', () => {
        // Check if we are already loading or if there are no more pages
        if (isLoading || !hasNextPage) {
            return;
        }
        currentPage++;
        fetchStores();
    });

    // Delegate click handling to results container
    resultsContainer.addEventListener("click", (e) => {
        const item = e.target.closest(".search-result-item");
        if (item) {
            nameInput.value = item.querySelector("span").innerText;
            resultsContainer.innerHTML = "";
            resultsContainer.style.display = "none";
        }
    });
});


</script>

<script>
    function getCSRFToken() {
        let name = 'csrftoken';
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

</script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const card = document.getElementById('gradient-card');
        const root = document.documentElement;

        // We will use HSL and an oscillating value to create a smooth,
        // controlled color shift within a specific range.
        let time = 0;
        // Initialize the angle based on the CSS variable
        let angle = 135;

        // This function will be called on every animation frame.
        function updateGradientColors() {
            // Increment a time variable to drive the color animation
            time += 0.01;

            // --- Animate the gradient angle ---
            // Slowly increment the angle, wrapping around at 360 degrees
            angle = (angle + 0.15) % 360;

            // Use Math.sin to create a smooth wave that oscillates between -1 and 1.
            const sinValue = Math.sin(time);

            // Map the sine value to a warm, yellowish hue range.
            // We'll oscillate between a peachy-orange (30) and a golden-yellow (60).
            const baseHue = 45; // Midpoint (Golden Yellow)
            const hueRange = 15;  // Oscillation range (45 +/- 15)
            const dynamicHue = baseHue + sinValue * hueRange;

            // Create a palette based on the oscillating hue and your theme colors
            const color1 = `hsl(${dynamicHue}, 95%, 88%)`;
            const color2 = '#ffd1bd'; // Your light accent color provides a warm, stable anchor
            const color3 = `hsl(${(dynamicHue + 25) % 360}, 95%, 90%)`;
            const color4 = '#fee8e0'; // Your lightest accent color brightens the mix

            // Update the CSS variables on the root element
            root.style.setProperty('--gradient-angle', `${angle}deg`); // This now updates continuously
            root.style.setProperty('--color-1', color1);
            root.style.setProperty('--color-2', color2);
            root.style.setProperty('--color-3', color3);
            root.style.setProperty('--color-4', color4);


            // Request the next animation frame to create a smooth loop
            requestAnimationFrame(updateGradientColors);
        }

        // Start the color animation loop
        requestAnimationFrame(updateGradientColors);
    });
</script>
{% endblock %}