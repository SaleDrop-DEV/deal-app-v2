{% extends "base.html" %}
{% load static %}

{% block title %}{{ store.name }} Sale & Korting - Recente Deals{% endblock %}

{% block head %}
<link rel="stylesheet" href="{% static 'css/theme_v2_deals.css' %}">

{# SEO Meta Tags #}
<meta name="description" content="Vind de laatste sales, kortingen en aanbiedingen van {{ store.name }} op SaleDrop. Mis geen enkele deal en bespaar direct.">
<meta name="keywords" content="{{ store.name }}, sale, korting, aanbieding, deals, kortingscode, uitverkoop, SaleDrop">
<meta name="robots" content="index, follow">
<link rel="canonical" href="{{ canonical_url }}">

{# Open Graph / Facebook Meta Tags #}
<meta property="og:title" content="SaleDrop | {{ store.name }} Sale & Korting - Recente Deals">
<meta property="og:description" content="Vind de laatste sales, kortingen en aanbiedingen van {{ store.name }} op SaleDrop.">
<meta property="og:image" content="https://saledrop.app{{ image_url }}">
<meta property="og:url" content="{{ canonical_url }}">
<meta property="og:type" content="website">
<meta property="og:locale" content="nl_NL">

<style>
    .product-overlay {
        margin-bottom: calc(env(safe-area-inset-bottom));
    }
    #small-screen-action-btn {
        top: 0 !important;
        left: 0 !important;
        position: relative !important;
        transform: none !important;
    }
    .new-badge {
        color: var(--color-accent);
        font-size: 0.65rem !important;
        padding: 0.15rem 0.4rem;
        font-weight: bold;
        background-color: var(--color-accent-light);
        border-radius: 20px;
    }
    .sale-grabber {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .sales-item {
        position: relative;
    }
    .probanility-badge {
        position: absolute;
        top: 3px;
        right: 3px;
        padding: 0.4rem;
        border-radius: 100px;
    }
    .high {
        color: var(--color-succes);
        background-color: rgba(216, 252, 216, 0.65);
    }
    .low {
        color: var(--color-error);
        background-color: rgba(255, 203, 203, 0.65);
    }

    /* ---- Search Bar ---- */
    .search-bar-container {
        width: 100%;
        display: flex;
        justify-content: center;
        padding: 0 1rem;
        position: relative; /* Make this the positioning context for the dropdown */
    }

    .search-bar {
        display: flex;
        align-items: center;
        background-color: var(--color-gray-lighter);
        max-width: 500px;
        width: 100%;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
    }

    .search-bar input {
        flex-grow: 1;
        border: none;
        outline: none;
        background-color: transparent;
        font-size: 1rem;
        padding: 1rem 0.5rem;
        color: var(--primary-text-color);
    }

    .search-bar input::placeholder {
        color: var(--secondary-text-color);
    }

    .search-bar button {
        background-color: var(--color-accent);
        border: none;
        color: white;
        padding: 0.5rem 0.75rem;
        margin-left: 0.5rem;
        cursor: pointer;
        font-weight: 600;
        transition: background-color 0.3s ease;
        display: flex;
        justify-content: center; /* Center content horizontally */
        align-items: center;     /* Center content vertically */
        height: 100%;
        aspect-ratio: 1 / 1; 
    }

    /* ---- Search Results Dropdown ---- */
    .search-section {
        position: sticky;
        top: var(--navbar-height);
        z-index: 800;
        background-color: var(--background-color);
        padding-top: 1rem;
        padding-bottom: 1rem;
        margin-bottom: 1.5rem;
        position: -webkit-sticky; /* For Safari */
    }

    #searchResults {
        display: none; /* Hidden by default */
        position: absolute;
        top: 100%; /* Position directly below the search bar container */
        left: 50%;
        width: 100%;
        transform: translateX(-50%);
        transform: translateX(-50%) scaleY(0); /* Start scaled to 0 height */
        transform-origin: top; /* Animate from the top edge */
        opacity: 0;
        visibility: hidden;
        transition: transform 0.2s ease-out, opacity 0.2s ease-out;
        max-width: 500px; /* Match the search bar width */
        background-color: white;
        border: 1px solid var(--color-gray-light);
        border-top: none;
        border-radius: 0 0 8px 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        max-height: 300px;
        overflow-y: auto;
        z-index: 800; /* Ensure it's on top */
    }

    @media(max-width: 520px) {
        #searchResults{
            width: calc(100% - 2rem);
        }
    }
    
    #searchResults.show {
        transform: translateX(-50%) scaleY(1); /* Scale to full height */
        opacity: 1;
        visibility: visible;
    }

    #searchResults a {
        text-decoration: none;
        color: var(--primary-text-color);
        display: block;
    }

    .store-result {
        display: flex;
        align-items: center;
        padding: 0.75rem 1rem;
        gap: 1rem;
        transition: background-color 0.2s ease;
    }

    .store-result:hover {
        background-color: var(--color-gray-lighter);
    }

    .store-result img {
        width: 40px;
        height: 40px;
        object-fit: contain;
        border-radius: 50%;
    }

    /* ---- Loader for Search Button ---- */
    .search-bar .loader {
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top: 3px solid white;
        width: 24px;  /* Increased size to match icon */
        height: 24px; /* Increased size to match icon */
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }


    .other_gender_link{
        color: var(--color-accent);
        text-decoration: none;
    }
    .other_gender_link:hover{
        color: var(--color-accent);
        text-decoration: underline;
    }


    .store-image{
        display: block;
        width: 100px;
        border-radius: 50%;
        margin: 0 auto;
    }

    @media (max-width: 600px){
        .store-image{
            width: 80px;
        }
        .store-name-title{
            font-size: 1.75rem;
        }
    }

    .app-store-link-body{
        color: var(--color-accent);
    }
    .app-store-link-body:hover{
        color: var(--color-accent);
        text-decoration: underline;
    }
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,500,0,0&icon_names=search" />

{% endblock %}

{% block content %}
{% csrf_token %}
    <div class="search-section">
        <div id="searchBarWrapper" class="search-bar-container">
            <div class="search-bar">
                <input id="searchInput" type="text" placeholder="Zoek winkels..." />
                <button id="searchButton" aria-label="Search">
                    <span style="color:white;" class="material-symbols-outlined search-icon">
                        search
                    </span>
                    <div class="loader" style="display: none;"></div>
                </button>
            </div>
            <div id="searchResults">
                <!-- This will be filled with results -->
                <a href="#">
                    <div class="store-result">
                        <img src="https://placehold.co/50x50/F5F5F7/86868B?text=Store" alt="">
                        <p>Store Name</p>
                    </div>
                </a>
                <a href="#">
                    <div class="store-result">
                        <img src="https://placehold.co/50x50/F5F5F7/86868B?text=Store" alt="">
                        <p>Store Name2</p>
                    </div>
                </a>
            </div>
        </div>
    </div>
    
    <div class="info-section" style="padding: 0.5rem;">
        <img class="store-image" src="https://saledrop.app{{ image_url }}" alt="{{ store.name}}-logo">
        <h1 class="store-name-title" style="margin: 1rem 0; text-align: center;">{{ storeName }}</h1>
        <p style="text-align: center; max-width: 600px; margin-left: auto; margin-right: auto; color: black;">
            {{ description }}
            {% if results|length != 0 %}Hieronder vind je de meest recente sales en deals van {{ storeName }}. {% endif %}
        </p>
    </div>

    <div id="sales-container" class="sales-container">
        {% for deal in results %}
            <div class="sales-item {% if deal.personal %}personal-sale{% endif %}">
                <h3 class="sale-title">{{ deal.title }}</h3>
                <p class="sale-grabber">{{ deal.grabber }}
                    {% if request.user.is_staff and deal.is_new_deal_better %}
                        <span class="new-badge">NIEUW</span>
                    {% endif %}
                </p>
                <p class="store-name accent-color">{{ deal.store.name }}
                    {% if request.user.is_staff and deal.gender %}
                        {% if deal.gender == 'B' %}
                            <i style="color: #FFF430;" class="gender-icon fa-solid fa-mars-and-venus"></i>
                        {% elif deal.gender == 'F' %}
                            <i style="color: #ff69B4;" class="gender-icon fa-solid fa-mars"></i>
                        {% elif deal.gender == 'M' %}
                            <i style="color: #6CA0DC;" class="gender-icon fa-solid fa-venus"></i>
                        {% endif %}
                    {% endif %}
                </p>
                {% if request.user.is_authenticated %}
                    <button class="primary-btn view-details-btn" onclick="handleShowDetails(this)">Bekijk</button>
                {% else %}
                    <button class="primary-btn view-details-btn" onclick="showAuthRequiredModal()">Bekijk</button>
                {% endif %}
                <p class="sale-date-received">{{ deal.parsed_date_received }}</p>
                <script class="sale-data" type="application/json">
                    {{ deal.deal_json|default_if_none:'{}'|safe }}
                </script>
                {% if request.user.is_staff and deal.deal_probability %}
                    <span class="probanility-badge {{ deal.noDisplay }}">{{ deal.deal_probability }}</span>
                {% endif %}
            </div>
        {% empty %}
            <p style="text-align: center;">
                Er zijn de afgelopen maand geen actieve sales gevonden voor {{ storeName }}.
                <br>
                Download SaleDrop in de <a target="_blank" class="app-store-link-body" href="https://apps.apple.com/nl/app/saledrop/id6751799791">AppStore</a> om als eerste op de hoogte te zijn van nieuwe sales van {{ storeName }}.
            </p>
        {% endfor %}

        {# This logic adds invisible cards to ensure the grid layout is always balanced #}
        {% if results|length == 1 %}
            <div class="sales-item" style="visibility: hidden;"></div>
            <div class="sales-item" style="visibility: hidden;"></div>
        {% endif %}
        {% if results|length == 2 %}
            <div class="sales-item" style="visibility: hidden;"></div>
        {% endif %}
    </div>

{% endblock %}

{% block overlay_content %}
    <!-- Product Overlay (for small screens) -->
    <div class="product-overlay" id="productOverlay">
        <div class="product-content-wrapper">
            <span class="product-close-btn material-icons">&times;</span>
            <div class="product-header">
                <h2 class="product-title"></h2>
                <div class="store-info">
                    <img src="" alt="Store Logo" class="store-logo">
                    <p class="store-name-detail"></p>
                </div>
                <p class="product-grabber"></p>
            </div>
            <div class="product-details">
                <p class="product-description"></p>
                <div class="highlighted-products-section">
                    <h3>Uitgelichte producten</h3>
                    <div class="highlighted-products-slider">
                        <!-- Products will be injected here -->
                    </div>
                </div>
                <div class="product-actions">
                </div>
            </div>
            <div style="position: relative;">
                <button id="small-screen-action-btn" class="action-btn" onclick="">Naar sale</button>
            </div>
        </div>
    </div>
{% endblock %}

{% block pop_up_content %}
    <!-- Pop-up (for large screens) -->
    <div class="modal-backdrop" id="modalBackdrop">
        <div class="product-modal">
            <span class="product-close-btn material-icons">&times;</span>
            <div class="product-header">
                <h2 class="product-title"></h2>
                <div class="store-info">
                    <img src="" alt="Store Logo" class="store-logo">
                    <p class="store-name-detail"></p>
                </div>
                <p class="product-grabber"></p>
            </div>
            <div class="product-scroll-area">
                <div class="product-details">
                    <p class="product-description"></p>
                    <div class="highlighted-products-section">
                        <h3>Highlighted Products</h3>
                        <div class="highlighted-products-slider">
                            <!-- Products will be injected here -->
                        </div>
                    </div>
                    <div class="product-actions">
                    </div>
                </div>
            </div>
            <button id="action-btn-large-screens" class="action-btn action-btn-pop-up">Naar sale</button>
        </div>
    </div>

    <!-- Pop-up for non-authenticated users -->
    <div class="modal-backdrop" id="authRequiredModalBackdrop">
        <div class="product-modal" style="text-align: center; padding: 2rem;">
            <span class="product-close-btn material-icons" onclick="document.getElementById('authRequiredModalBackdrop').classList.remove('show'); document.body.style.overflow = 'auto';">&times;</span>
            <h2 style="margin-bottom: 1rem;">Krijg toegang tot alle details</h2>
            <p style="margin-bottom: 2rem; color: var(--secondary-text-color);">
                Maak een gratis account aan om de volledige beschrijving en de directe link naar deze en vele andere sales te zien.
            </p>
            <div style="display: flex; flex-direction: column; gap: 1rem;">
                <a href="{% url 'signup_view' %}" class="primary-btn" style="text-decoration: none; display: block; padding: 0.8rem;">Maak een account aan</a>
                <a href="https://apps.apple.com/nl/app/saledrop/id6751799791" class="secondary-btn" style="text-decoration: none; display: block; padding: 0.8rem;">Download in de App Store</a>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
    // --- Global variables for modals ---
    let productOverlay, modalBackdrop, productContentWrapper, productModal;
    let productTitleElements, productGrabberElements, productDescriptionElements, highlightedProductsSliderElements;
    let storeNameDetailElements, storeLogoElements, productMainLinkElements;
    let action_btn_for_small_screens;


    // Variables for swipe-down-to-close
    let startY = 0;
    let currentY = 0;
    let diffY = 0;
    let isSwipingDown = false;
    const swipeThreshold = 10; // Pixels to swipe down to trigger dismiss

    // Function to populate and show the product detail view
    window.showProductDetails = function(dealData) {
        // Populate content for all instances (overlay and modal)
        productTitleElements.forEach(el => el.textContent = dealData.title || 'No Title');
        productGrabberElements.forEach(el => el.textContent = dealData.grabber || 'No Grabber');
        productDescriptionElements.forEach(el => el.textContent = dealData.description || 'No Description');
        storeNameDetailElements.forEach(el => el.textContent = dealData.store ? dealData.store.name : 'Unknown Store');
        productMainLinkElements.forEach(el => {
            el.href = dealData.main_link || '#';
            el.style.display = dealData.main_link ? 'inline-block' : 'none'; // Hide button if no link
        });
        storeLogoElements.forEach(el => {
            el.src = dealData.store && dealData.store.image_url ? dealData.store.image_url : 'https://placehold.co/50x50/F5F5F7/86868B?text=Store';
            el.alt = dealData.store && dealData.store.name ? `${dealData.store.name} Logo` : 'Store Logo';
        });

        // Populate highlighted products slider
        highlightedProductsSliderElements.forEach(slider => {
            slider.innerHTML = ''; // Clear previous products
            if (dealData.highlighted_products && Array.isArray(dealData.highlighted_products) && dealData.highlighted_products.length > 0) {
                dealData.highlighted_products.forEach(product => {
                    const productDiv = document.createElement('div');
                    productDiv.classList.add('highlighted-product-item');
                    const old_price = product.old_price;
                    const new_price = product.new_price;
                    let price_p = ''
                    if (old_price && new_price) {
                        price_p = `<p class="product-item-price">${product.new_price && product.new_price !== 'N/A' ? `€${parseFloat(product.new_price).toFixed(2)}` : (product.old_price && product.old_price !== 'N/A' ? `€${parseFloat(product.old_price).toFixed(2)}` : '')}</p>`
                    }

                    productDiv.innerHTML = `
                        <img src="${product.product_image_url || 'https://placehold.co/100x100/F5F5F7/86868B?text=Product'}" alt="${product.title || 'Product'} Image">
                        <p class="product-item-name">${product.title || 'Onbekend'}</p>
                        ${price_p}
                    `;
                    slider.appendChild(productDiv);
                });
                document.getElementsByClassName('highlighted-products-section')[0].style.display = 'block';
                document.getElementsByClassName('highlighted-products-section')[1].style.display = 'block';
            } else {
                document.getElementsByClassName('highlighted-products-section')[0].style.display = 'none';
                document.getElementsByClassName('highlighted-products-section')[1].style.display = 'none';
                slider.innerHTML = '<p class="no-products-message">Geen uitgelichte producten gevonden.</p>';
            }
        });

        // Determine screen size and show appropriate view
        if (window.matchMedia('(max-width: 767px)').matches) {
            // Small screen: slide-up overlay
            productOverlay.classList.add('show');
            action_btn_for_small_screens.classList.remove('hide-action-btn')
            action_btn_for_small_screens.classList.add('show-action-btn');
            action_btn_for_small_screens.onclick = () => {
                go_to_sale(dealData.main_link);
            }
            document.body.style.overflow = 'hidden'; // Prevent scrolling body
            // Reset transform in case it was moved by a previous failed swipe
            productContentWrapper.style.transform = 'translateY(0)';
            productContentWrapper.style.transition = 'transform 0.3s ease-out'; // Ensure transition is active
        } else {
            // Large screen: modal pop-up
            modalBackdrop.classList.add('show');
            document.getElementById("action-btn-large-screens").onclick = () => {
                go_to_sale(dealData.main_link);
            }
            // document.getElementById("action-btn-large-screens").style.top = top_offset - (60 - 32) + "px";
            document.body.style.overflow = 'hidden'; // Prevent scrolling body
            // Reset transform for modal as well
            productModal.style.transform = 'scale(1)';
            productModal.style.transition = 'transform 0.3s ease-out'; // Ensure transition is active
        }
    }

    // Function to hide the product detail view
    function hideProductDetails() {
        // Trigger fade-out/slide-down animation
        if (window.matchMedia('(max-width: 767px)').matches) {
            productContentWrapper.style.transform = 'translateY(100%)'; // Slide down
            productOverlay.classList.remove('show'); // Fade out backdrop
            action_btn_for_small_screens.classList.add('hide-action-btn')
            action_btn_for_small_screens.classList.remove('show-action-btn');
        } else {
            productModal.style.transform = 'scale(0.9)'; // Pop back in
            modalBackdrop.classList.remove('show'); // Fade out backdrop
        }

        // Wait for the animation to complete before hiding completely and restoring scroll
        const transitionEndHandler = () => {
            productOverlay.classList.remove('show'); // Ensure overlay is fully hidden
            modalBackdrop.classList.remove('show'); // Ensure modal is fully hidden
            document.body.style.overflow = ''; // Restore body scrolling
            // Remove the event listener to prevent multiple calls
            productContentWrapper.removeEventListener('transitionend', transitionEndHandler);
            productModal.removeEventListener('transitionend', transitionEndHandler);
        };

        // Add event listeners for transition end
        productContentWrapper.addEventListener('transitionend', transitionEndHandler);
        productModal.addEventListener('transitionend', transitionEndHandler);
    }

    function go_to_sale(link){
        window.open(link, '_blank');
    }

    /**
     * Shows the deal details modal for an authenticated user.
     * 'element' is the button that was clicked.
     */
    function handleShowDetails(element) {
        const salesItem = element.closest('.sales-item');
        const scriptTag = salesItem.querySelector('.sale-data[type="application/json"]');

        if (scriptTag && scriptTag.textContent) {
            try {
                const dealData = JSON.parse(scriptTag.textContent);
                // The global showProductDetails function is in sale_cards_modal_logic.js
                window.showProductDetails(dealData);
            } catch (e) {
                console.error('Error parsing JSON data for sale item:', e);
            }
        } else {
            console.warn('No JSON data script tag found for this sale item.');
        }
    }

    /**
     * Shows the "create account" modal for a non-authenticated user.
     */
    function showAuthRequiredModal() {
        document.getElementById('authRequiredModalBackdrop').classList.add('show');
        document.body.style.overflow = 'hidden';
    }

    document.addEventListener('DOMContentLoaded', function() {
        // --- Initialize global variables ---
        productOverlay = document.getElementById('productOverlay');
        modalBackdrop = document.getElementById('modalBackdrop');
        productContentWrapper = productOverlay.querySelector('.product-content-wrapper');
        productModal = modalBackdrop.querySelector('.product-modal');
        const productCloseBtns = document.querySelectorAll('.product-close-btn');
        
        productTitleElements = document.querySelectorAll('.product-title');
        productGrabberElements = document.querySelectorAll('.product-grabber');
        productDescriptionElements = document.querySelectorAll('.product-description');
        highlightedProductsSliderElements = document.querySelectorAll('.highlighted-products-slider');
        storeNameDetailElements = document.querySelectorAll('.store-name-detail');
        storeLogoElements = document.querySelectorAll('.store-logo');
        productMainLinkElements = document.querySelectorAll('.product-main-link');
        action_btn_for_small_screens = document.getElementById('small-screen-action-btn');

        // --- Attach Event Listeners (Modals) ---

        // Event listeners for close buttons (X icon)
        productCloseBtns.forEach(btn => {
            btn.addEventListener('click', hideProductDetails);
        });

        // Close modal/overlay when clicking outside the content (for large screens)
        modalBackdrop.addEventListener('click', (event) => {
            if (event.target === modalBackdrop) {
                hideProductDetails();
            }
        });

        // Also handle closing the auth modal when clicking its backdrop
        const authRequiredModal = document.getElementById('authRequiredModalBackdrop');
        if (authRequiredModal) {
            authRequiredModal.addEventListener('click', (event) => {
                if (event.target === authRequiredModal) {
                    authRequiredModal.classList.remove('show');
                    document.body.style.overflow = 'auto';
                }
            });
        }

        // Prevent clicks inside the content from closing the modal/overlay
        productContentWrapper.addEventListener('click', (event) => event.stopPropagation());
        productModal.addEventListener('click', (event) => event.stopPropagation());

        // --- Swipe-down-to-close for Mobile Overlay ---
        productContentWrapper.addEventListener('touchstart', (e) => {
            if (window.matchMedia('(max-width: 767px)').matches) {
                startY = e.touches[0].clientY;
                productContentWrapper.style.transition = 'none';
            }
        });

        productContentWrapper.addEventListener('touchmove', (e) => {
            if (window.matchMedia('(max-width: 767px)').matches) {
                currentY = e.touches[0].clientY;
                diffY = currentY - startY;

                if (productContentWrapper.scrollTop === 0 && diffY > 0) {
                    isSwipingDown = true;
                    productContentWrapper.style.transform = `translateY(${diffY}px)`;
                    e.preventDefault();
                } else if (diffY < 0 && productContentWrapper.scrollTop > 0) {
                    isSwipingDown = false;
                } else if (productContentWrapper.scrollTop === 0 && diffY < 0) {
                    productContentWrapper.style.transform = `translateY(0px)`;
                    isSwipingDown = false;
                    e.preventDefault();
                }
            }
        });

        productContentWrapper.addEventListener('touchend', () => {
            if (window.matchMedia('(max-width: 767px)').matches) {
                productContentWrapper.style.transition = 'transform 0.3s ease-out';

                if (isSwipingDown && diffY > swipeThreshold) {
                    hideProductDetails();
                } else {
                    productContentWrapper.style.transform = 'translateY(0)';
                }

                startY = 0;
                currentY = 0;
                diffY = 0;
                isSwipingDown = false;
            }
        });

        // --- Search Bar Functionality ---
        const searchInput = document.getElementById('searchInput');
        const searchResultsContainer = document.getElementById('searchResults');
        const searchButton = document.getElementById('searchButton');
        const searchBarWrapper = document.getElementById('searchBarWrapper');

        let searchTimeout;

        // Function to show the search results with the transition
        function showSearchResults() {
            // Check if results are already showing to prevent interrupting the transition
            if (searchResultsContainer.classList.contains('show')) return; 

            searchResultsContainer.style.display = 'block'; 
            setTimeout(() => {
                searchResultsContainer.classList.add('show');
            }, 10);
        }

        // Function to hide the search results with the transition
        function hideSearchResults() {
            searchResultsContainer.classList.remove('show');
            // Wait for the CSS transition (0.2s) to finish before setting display: none
            setTimeout(() => {
                searchResultsContainer.style.display = 'none';
            }, 200);
        }

        // --- NEW: Re-open on focus ---
        searchInput.addEventListener('focus', () => {
            const query = searchInput.value.trim();
            // Show the container
            showSearchResults();
            
            // If there's enough text, refresh the results instantly
            if (query.length >= 2) {
                fetchStoreResults(query);
            } else {
                // If there's no query, ensure the container is clear (if it had previous results)
                searchResultsContainer.innerHTML = '';
            }
        });

        searchInput.addEventListener('input', () => {
            // Clear the previous timeout to debounce
            clearTimeout(searchTimeout);

            const query = searchInput.value.trim();

            if (query.length < 2) {
                hideSearchResults(); 
                searchResultsContainer.innerHTML = '';
                return;
            }

            // Set a new timeout
            searchTimeout = setTimeout(() => {
                fetchStoreResults(query);
            }, 300); // 300ms delay
        });

        searchButton.addEventListener('click', () => {
            // Re-fetch on button click
            const query = searchInput.value.trim();
            if (query.length >= 1) {
                fetchStoreResults(query);
            }
        });

        // --- Global click listener to hide results ---
        document.addEventListener('click', (event) => {
            const isClickInsideSearchBar = searchBarWrapper.contains(event.target);
            const isResultsShowing = searchResultsContainer.classList.contains('show');

            // If the results are showing AND the click is NOT inside the search bar wrapper
            if (isResultsShowing && !isClickInsideSearchBar) {
                hideSearchResults();
            }
        });

        async function fetchStoreResults(query) {
            const searchIcon = searchButton.querySelector('.search-icon');
            const loader = searchButton.querySelector('.loader');
            searchIcon.style.display = 'none';
            loader.style.display = 'block';
            try {
                const response = await fetch('/api/search-stores/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}',
                    },
                    body: JSON.stringify({ query: query, page: 1 }),
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok.');
                }

                const data = await response.json();
                renderSearchResults(data.stores);

            } catch (error) {
                console.error('Error fetching search results:', error);
                searchResultsContainer.innerHTML = '<div class="store-result"><p>Er is een fout opgetreden.</p></div>';
                showSearchResults();
            } finally {
                searchIcon.style.display = 'inline-block';
                loader.style.display = 'none';
            }
        }

        function renderSearchResults(stores) {
            searchResultsContainer.innerHTML = ''; // Clear previous results

            if (!stores || stores.length === 0) {
                searchResultsContainer.innerHTML = '<div class="store-result"><p>Geen winkels gevonden.</p></div>';
            } else {
                stores.forEach(store => {
                    if (store.store_links && store.store_links.length > 1) {
                        // Create a result for "Mannen" (Men)
                        const storeElementM = document.createElement('a');
                        storeElementM.href = store.store_links[0];
                        storeElementM.innerHTML = `
                            <div class="store-result">
                                <img src="${store.image_url}" alt="${store.name} logo">
                                <p>${store.name} (Mannen)</p>
                            </div>`;
                        searchResultsContainer.appendChild(storeElementM);

                        // Create a result for "Vrouwen" (Women)
                        const storeElementF = document.createElement('a');
                        storeElementF.href = store.store_links[1];
                        storeElementF.innerHTML = `
                            <div class="store-result">
                                <img src="${store.image_url}" alt="${store.name} logo">
                                <p>${store.name} (Vrouwen)</p>
                            </div>`;
                        searchResultsContainer.appendChild(storeElementF);
                    } else {
                        // Default behavior for stores with one link
                        const storeLink = store.store_links[0] || '#';
                        const storeElement = document.createElement('a');
                        storeElement.href = storeLink;
                        storeElement.innerHTML = `
                            <div class="store-result">
                                <img src="${store.image_url}" alt="${store.name} logo">
                                <p>${store.name}</p>
                            </div>`;
                        searchResultsContainer.appendChild(storeElement);
                    }
                });
            }
            showSearchResults();
        }
    });
</script>
{% endblock %}